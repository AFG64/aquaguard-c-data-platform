# AquaGuard — Low-Level Notes
- Entry point: `src/main.c` parses CLI flags (`--mode`, `--tcp-host`, `--tcp-port`, `--web-port`), initializes shared state, installs `SIGINT`/`SIGPIPE` handlers, and spawns two pthreads (sensor + HTTP).
- Threading: `main.c` launches `sensor_thread` (in `sensor.c`) and `http_thread` (in `http.c`). Threads share one heap-allocated `SharedState` guarded by a `pthread_mutex_t` to avoid torn reads/writes.
- Shared state: Defined in `include/shared.h` (`SensorData`, alert bitmask `AlertFlags`, thresholds macros). Mutex wraps every read/write of the shared struct. Alert thresholds and connection status live here to keep parameters centralized.
- Sensor path (`src/sensor.c`):
  - TCP client using `getaddrinfo`/`socket`/`connect`; reconnect with exponential backoff if the simulator drops.
  - Reads newline-delimited JSON lines; non-blocking-ish behavior via short timeouts to avoid freezing.
  - Calls `parse_json_line` (from `json.c`), updates alerts/metrics inside a mutex, sets connection status.
- Parser (`src/json.c`):
  - Hand-rolled scanner for fixed keys: `flow`, `humidity`, `temperature`, `pressure`, `emergency` (bool).
  - Produces a struct with floats/bools, sets alert bitmask based on thresholds in `shared.h`.
  - Returns status codes so bad lines are skipped without crashing the gateway.
- HTTP/SSE (`src/http.c`):
  - Minimal HTTP server on `web_port` serving static files from `web/` and SSE at `/events`.
  - SSE loop grabs a snapshot of `SharedState` under mutex and streams JSON to the browser.
  - Ignores `SIGPIPE` so reloads don’t kill the process.
- Data contract:
  - Incoming: newline JSON per line, floats for metrics, bool for emergency.
  - Outgoing SSE payload: JSON with metrics, connection status enum, alert bitmask; web UI maps bitmask → banner + highlights.
- Build/test/tooling:
  - Build: `cmake -S . -B build -DCMAKE_BUILD_TYPE=Release && cmake --build build -j`.
  - Tests: `ctest --test-dir build --output-on-failure` runs `tests/test_parser.c` (parser + thresholds).
  - Env: `environment.yml` (Python ≥3.10, Tk, CMake, Make) to align simulator + build tools.
  - CI: `.github/workflows/ci.yml` runs configure/build/ctest on Ubuntu/macOS for push/PR.
- Rationale anchors:
  - No external JSON lib to avoid portability headaches.
  - Two threads only (sensor + HTTP) to keep concurrency simple and debuggable.
  - Centralized thresholds/flags in `shared.h` to ensure the C side and UI stay consistent.
